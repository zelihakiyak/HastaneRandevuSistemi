@model AppointmentCreateViewModel

<div class="max-w-6xl mx-auto px-6 py-12">
    <h1 class="text-4xl font-bold text-gray-900 mb-12">Randevu Al</h1>

    <form asp-action="Create" method="post">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-16">

            <div class="space-y-12">
                <section>
                    <h2 class="text-xl font-bold mb-6">Adım 1: Doktorunuzu Seçiniz</h2>
                    <div class="space-y-4">                    
                        <select asp-for="SelectedDepartmentName" id="deptSelect" class="w-full p-4 border border-gray-100 rounded-xl bg-gray-50 focus:ring-2 focus:ring-red-500 outline-none">
                            <option value="">Bölüm Seçiniz</option>
                            @if (Model.Departments != null)
                            {
                                foreach (var dept in Model.Departments)
                                {
                                    <option value="@dept">@dept</option>
                                }
                            }
                        </select>

                        <select asp-for="SelectedDoctorId" id="docSelect" class="w-full p-4 border border-gray-100 rounded-xl bg-gray-50 focus:ring-2 focus:ring-red-500 outline-none" disabled>
                            <option value="">Önce Bölüm Seçiniz</option>
                        </select>
                    </div>
                </section>

                <section>
                    <h2 class="text-xl font-bold mb-6">Adım 2: Randevu Tarihinizi Seçiniz</h2>

                    @{                     
                        var minDate = DateTime.Now.Hour >= 17 ? DateTime.Today.AddDays(1) : DateTime.Today;
                    }

                    <input type="date"
                           asp-for="SelectedDate"
                           id="appDate"
                           min="@minDate.ToString("yyyy-MM-dd")"
                           class="w-full p-4 bg-white border border-gray-100 rounded-2xl shadow-sm text-lg font-semibold outline-none focus:ring-2 focus:ring-red-500" />
                </section>
            </div>

            <div class="space-y-12">
                <section>
                    <h2 class="text-xl font-bold mb-6">Adım 3: Randevu Saatinizi Seçiniz</h2>
                    <div id="slotsContainer" class="grid grid-cols-3 gap-4">
                        <p class="col-span-3 text-gray-400 italic">Doktor ve tarih seçtiğinizde saatler burada görünecek.</p>
                    </div>
                    <input type="hidden" asp-for="SelectedSlot" id="selectedSlotValue" />
                </section>

                <button type="submit" class="w-full bg-[#ef4444] text-white font-bold py-4 rounded-xl text-lg hover:bg-red-600 transition shadow-lg shadow-red-100">
                    Randevuyu Onayla
                </button>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const now = new Date();
            if (now.getHours() >= 17) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];

                // Eğer input'un min değeri hala bugünse, yarın ile güncelle
                $('#appDate').attr('min', tomorrowStr);
            }
            // 1. Bölüm değişince Doktorları getir (Cascading)
            $('#deptSelect').change(function () {
                const deptName = $(this).val();
                const docSelect = $('#docSelect');

                docSelect.empty().append('<option value="">Doktorlar Yükleniyor...</option>');

                if (deptName) {
                    $.getJSON('/Appointment/GetDoctors', { departmentName: deptName }, function (data) {
                        docSelect.empty().append('<option value="">Doktor Seçiniz</option>');
                        $.each(data, function (i, item) {
                            docSelect.append($('<option>', { value: item.id, text: item.fullName }));
                        });
                        docSelect.prop('disabled', false);
                    });
                } else {
                    docSelect.empty().append('<option value="">Önce Bölüm Seçiniz</option>').prop('disabled', true);
                }
            });

            // 2. Doktor veya Tarih değişince Saatleri (Slots) getir
            $('#docSelect, #appDate').on('change', function () {
               
                const dateInput = $('#appDate');
                const dateValue = dateInput.val();

                if (dateValue) {
                    const date = new Date(dateValue);
                    const day = date.getUTCDay(); // 0: Pazar, 6: Cumartesi

                    // Hafta sonu kontrolü (0 = Pazar, 6 = Cumartesi)
                    if (day === 0 || day === 6) {
                        alert("Hafta sonları hastanemiz kapalıdır. Lütfen hafta içi bir gün seçiniz.");
                        dateInput.val(''); // Tarih alanını temizle
                        $('#slotsContainer').html('<p class="col-span-3 text-gray-400 italic">Doktor ve tarih seçtiğinizde saatler burada görünecek.</p>');
                        return;
                    }
                }
                
                const docId = $('#docSelect').val();
                const date = $('#appDate').val(); // HTML date input 'YYYY-MM-DD' döner

                if (docId && date) {
                    // Parametre ismini 'dateStr' olarak güncelledik ve URL'i Controller ile eşitledik
                    $.getJSON('/Appointment/GetAvailableSlots', { doctorId: docId, dateStr: date }, function (data) {
                        let html = '';
                        if (data && data.length > 0) {
                            data.forEach(slot => {
                                html += `<button type="button" onclick="setSlot(this, '${slot}')"
                                         class="slot-btn border border-gray-200 p-4 rounded-xl text-center font-bold hover:bg-red-50 hover:text-red-500 transition">${slot}</button>`;
                            });
                        } else {
                            html = '<p class="col-span-3 text-red-400 font-medium">Seçilen tarihte uygun saat bulunamadı.</p>';
                        }
                        $('#slotsContainer').html(html);
                    });
                }
            });

        });

        // Saat kutusuna tıklandığında değeri hidden input'a yaz ve görseli güncelle
        function setSlot(btn, value) {
            $('.slot-btn').removeClass('bg-red-500 text-white border-red-500').addClass('bg-white text-gray-800');
            $(btn).addClass('bg-red-500 text-white border-red-500');
            $('#selectedSlotValue').val(value);
        }
    </script>
}